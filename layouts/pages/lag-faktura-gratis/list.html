<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <title>Lag Faktura Gratis - ReAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {{ partial "head.html" . }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
      // Initialize jsPDF
      window.jsPDF = window.jspdf.jsPDF;
      // Wait for html2pdf to be fully loaded
      function waitForHtml2Pdf() {
        return new Promise((resolve, reject) => {
          if (window.html2pdf) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.html2pdf) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
            // Timeout after 5 seconds
            setTimeout(() => {
              clearInterval(checkInterval);
              reject(new Error('html2pdf failed to load'));
            }, 5000);
          }
        });
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      }
      .invoice-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .invoice-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .invoice-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .invoice-meta {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .invoice-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      .invoice-table th,
      .invoice-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      .invoice-table th {
        background-color: #f5f5f5;
      }
      .text-right {
        text-align: right;
      }
      .text-center {
        text-align: center;
      }
      .mt-4 {
        margin-top: 1rem;
      }
      .mb-4 {
        margin-bottom: 1rem;
      }
      .footer {
        margin-top: 50px;
        padding-top: 15px;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #666;
        text-align: center;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    {{ partial "header.html" . }}
    <main class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <div class="mt-12 flex justify-center">
        <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-4xl">
          <h1 class="text-2xl font-bold mb-4 text-center">
            Fyll ut feltene nedenfor
          </h1>
          <p class="text-gray-600 text-center mb-8">
            Legg til linjer etter behov, og last ned som PDF.
          </p>

          <form class="space-y-8" onsubmit="event.preventDefault();">
            <!-- Selger/Kjøper Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h2 class="text-lg font-semibold mb-4">Selgerinformasjon</h2>
                <input
                  type="text"
                  placeholder="Navn"
                  class="border rounded p-2 w-full mb-2"
                  id="seller-name"
                />
                <input
                  type="text"
                  placeholder="Adresse"
                  class="border rounded p-2 w-full mb-2"
                  id="seller-address"
                />
                <input
                  type="text"
                  placeholder="Postnummer/Sted"
                  class="border rounded p-2 w-full mb-2"
                  id="seller-postal"
                />
                <input
                  type="tel"
                  placeholder="Telefon"
                  class="border rounded p-2 w-full mb-2"
                  id="seller-phone"
                />
                <input
                  type="email"
                  placeholder="E-post"
                  class="border rounded p-2 w-full"
                  id="seller-email"
                />
              </div>

              <div>
                <h2 class="text-lg font-semibold mb-4">Kjøperinformasjon</h2>
                <input
                  type="text"
                  placeholder="Navn/Firmanavn"
                  class="border rounded p-2 w-full mb-2"
                  id="buyer-name"
                />
                <input
                  type="text"
                  placeholder="Organisasjonsnummer"
                  class="border rounded p-2 w-full mb-2"
                  id="buyer-org"
                />
                <input
                  type="text"
                  placeholder="Adresse"
                  class="border rounded p-2 w-full mb-2"
                  id="buyer-address"
                />
                <input
                  type="text"
                  placeholder="Postnummer/Sted"
                  class="border rounded p-2 w-full"
                  id="buyer-postal"
                />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input
                type="text"
                placeholder="Fakturanummer"
                class="border rounded p-2 w-full"
                id="invoice-number"
              />
              <input
                type="date"
                value="2025-08-18"
                class="border rounded p-2 w-full"
                id="invoice-date"
              />
              <input
                type="date"
                value="2025-09-01"
                class="border rounded p-2 w-full"
                id="due-date"
              />
            </div>

            <table class="w-full border">
              <thead>
                <tr class="bg-gray-100">
                  <th class="border p-2 text-left">Beskrivelse</th>
                  <th class="border p-2 text-right">Antall</th>
                  <th class="border p-2 text-right">Å-pris</th>
                  <th class="border p-2 text-right">MVA %</th>
                  <th class="border p-2 text-right">Sum (NOK)</th>
                  <th class="w-14"></th>
                </tr>
              </thead>
              <tbody id="items-body">
                <tr>
                  <td class="border p-2">
                    <input type="text" class="w-full p-1 border rounded desc" />
                  </td>
                  <td class="border p-2">
                    <input
                      type="number"
                      value="1"
                      min="0"
                      class="w-full p-1 border rounded qty text-right"
                    />
                  </td>
                  <td class="border p-2">
                    <input
                      type="number"
                      value="0.00"
                      min="0"
                      class="w-full p-1 border rounded price text-right"
                    />
                  </td>
                  <td class="border p-2">
                    <input
                      type="number"
                      value="25"
                      min="0"
                      class="w-full p-1 border rounded vat text-right"
                    />
                  </td>
                  <td class="border p-2">
                    <input
                      type="number"
                      value="0.00"
                      readonly
                      class="w-full p-1 border rounded line-sum bg-gray-50 text-right"
                    />
                  </td>
                  <td class="border p-2 text-center">
                    <button
                      type="button"
                      class="remove-row px-2 py-1 text-red-600 hover:text-red-800"
                    >
                      ✕
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
            <button
              type="button"
              id="add-row"
              class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              Legg til rad
            </button>

            <div class="text-right space-y-1">
              <p>
                Delsum:
                <span id="subtotal" class="font-semibold">0.00 NOK</span>
              </p>
              <p>
                MVA: <span id="vatTotal" class="font-semibold">0.00 NOK</span>
              </p>
              <p>
                Sum å betale:
                <span id="grandTotal" class="font-bold">0.00 NOK</span>
              </p>
            </div>

            <div>
              <input
                type="text"
                placeholder="Betales til konto"
                class="border rounded p-2 w-full"
                id="payment-account"
              />
            </div>

            <button
              type="button"
              id="download-pdf"
              class="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              Last ned som PDF
            </button>
          </form>
        </div>
      </div>
    </div>
    </main>
    {{ partial "footer.html" . }}
    <script>
      function calculateTotals() {
        let subtotal = 0, vatTotal = 0;
        document.querySelectorAll('#items-body tr').forEach(tr => {
          const qty = parseFloat(tr.querySelector('.qty').value) || 0;
          const price = parseFloat(tr.querySelector('.price').value) || 0;
          const vat = parseFloat(tr.querySelector('.vat').value) || 0;
          const lineSum = qty * price;
          const lineVAT = lineSum * (vat / 100);
          tr.querySelector('.line-sum').value = (lineSum).toFixed(2);
          subtotal += lineSum;
          vatTotal += lineVAT;
        });
        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' NOK';
        document.getElementById('vatTotal').textContent = vatTotal.toFixed(2) + ' NOK';
        document.getElementById('grandTotal').textContent = (subtotal + vatTotal).toFixed(2) + ' NOK';
      } 

      document.querySelector('#items-body').addEventListener('input', e => {
        if (e.target.matches('.qty, .price, .vat')) calculateTotals();
      });

      document.getElementById('add-row').addEventListener('click', () => {
        const row = document.querySelector('#items-body tr').cloneNode(true);
        row.querySelectorAll('input').forEach(input => input.value = input.classList.contains('line-sum') ? '0.00' : '');
        document.querySelector('#items-body').appendChild(row);
      });

      document.getElementById('items-body').addEventListener('click', e => {
        if (e.target.classList.contains('remove-row')) {
          if (document.querySelectorAll('#items-body tr').length > 1) {
            e.target.closest('tr').remove();
            calculateTotals();
          }
        }
      });

      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('no-NO');
      }

      // Function to load scripts dynamically
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = () => reject(new Error(`Script load error for ${src}`));
      document.head.appendChild(script);
    });
  }

  async function generateAndDownloadPDF() {
    console.log('Starting PDF generation...');
    const btn = document.getElementById('download-pdf');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'Genererer PDF...';
    }

    try {
        if (!window.jspdf) {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
            window.jsPDF = window.jspdf.jsPDF;
        }
        
        if (!window.html2canvas) {
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
        }
        
        const invoiceContainer = document.querySelector('.bg-white.rounded-lg.p-8');
        if (!invoiceContainer) throw new Error('Kunne ikke finne fakturaen');

        const clone = invoiceContainer.cloneNode(true);
        
        // Remove unnecessary elements
        ['#download-pdf', 'h1', '#add-row', 'button:not(.remove-row)', 'p.text-center'].forEach(selector => {
            const el = clone.querySelector(selector);
            if (el) el.remove();
        });
        
        // Replace inputs with spans
        clone.querySelectorAll('input').forEach(input => {
            const parent = input.parentNode;
            if (parent) {
                const value = input.value || (input.type === 'date' ? formatDate(input.value) : '');
                const span = document.createElement('span');
                span.textContent = value;
                span.style.display = 'inline-block';
                span.style.minHeight = '20px';
                span.style.width = '100%';
                span.className = input.className.replace('border', '').replace('rounded', '');
                parent.replaceChild(span, input);
            }
        });
        
        clone.querySelectorAll('input').forEach(input => input.remove());
        clone.querySelectorAll('button').forEach(button => button.remove());
        
        // Add title
        const title = document.createElement('h1');
        title.textContent = 'FAKTURA';
        title.style.textAlign = 'center';
        title.style.fontSize = '24px';
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '10px';
        clone.insertBefore(title, clone.firstChild);
        
        // Add payment info
        const paymentInfo = document.createElement('div');
        paymentInfo.style.marginTop = '20px';
        paymentInfo.style.paddingTop = '15px';
        paymentInfo.style.borderTop = '1px solid #eee';
        paymentInfo.innerHTML = `<p>${document.getElementById('payment-account')?.value || 'Betales til konto:'}</p>`;
        clone.appendChild(paymentInfo);
        
        // Style adjustments
        clone.style.width = '190mm';
        clone.style.padding = '10mm';
        clone.style.margin = '0';
        clone.style.boxShadow = 'none';
        clone.style.border = 'none';
        
        // Create off-screen container for PDF generation
        const offscreenContainer = document.createElement('div');
        offscreenContainer.style.position = 'absolute';
        offscreenContainer.style.left = '-9999px';
        offscreenContainer.style.top = '0';
        offscreenContainer.style.width = '210mm';
        offscreenContainer.appendChild(clone);
        document.body.appendChild(offscreenContainer);
        
        const canvas = await html2canvas(clone, {
            scale: 1.5,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false
        });
        
        const pdf = new window.jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 180;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 15, 10, imgWidth, imgHeight);
        
        const invoiceNumber = document.getElementById('invoice-number')?.value || 'faktura';
        pdf.save(`faktura_${invoiceNumber}.pdf`);
        
    } catch (error) {
        console.error('PDF Error:', error);
        alert('Kunne ikke generere PDF. Vennligst prøv igjen. Feil: ' + error.message);
    } finally {
        const offscreenContainer = document.querySelector('div[style*="left: -9999px"]');
        if (offscreenContainer) offscreenContainer.remove();
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Last ned som PDF';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
        const downloadBtn = document.getElementById('download-pdf');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            generateAndDownloadPDF().catch(error => {
              console.error('Error in PDF generation:', error);
              alert('Feil ved generering av PDF: ' + error.message);
            });
          });
        }
      });
    </script>
  </body>
</html>
