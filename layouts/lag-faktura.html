{{ define "main" }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>

<main class="mx-auto my-12 max-w-[860px] rounded-2xl bg-white p-8 md:p-10 shadow-lg">
    <p class="mb-6">
        Fyll ut feltene under, legg til linjer etter behov, og last ned som PDF. <b>Fakturamalen</b> er helt gratis
        å bruke og informasjonen din lagres til neste gang så du slipper å skrive alt på nytt. Du kan alltid bruke
        reai.no for å lage gratis faktura.
    </p>

    <!-- ========== SELGER ========= -->
    <section class="mb-10">
        <h2 class="mb-4 text-xl font-semibold">Selgerinformasjon (deg)</h2>
        <div class="grid gap-4 sm:grid-cols-2">
            <label class="flex flex-col"><span class="mb-1 font-semibold">Navn</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="seller-name"
                                                                                            required></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Kontonummer (IBAN/norsk)</span><input
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="seller-account"
                    required></label>
            <label class="sm:col-span-2 flex flex-col"><span class="mb-1 font-semibold">Adresse</span><textarea
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="seller-address" required
                    rows="2"></textarea></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Postnummer/Sted</span><input
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="seller-postcode"
                    required></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Telefon</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                               id="seller-phone"></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">E-post</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                              id="seller-email"
                                                                                              type="email"></label>
        </div>
    </section>

    <!-- ========== KJØPER ========= -->
    <section class="mb-10">
        <h2 class="mb-4 text-xl font-semibold">Kjøperinformasjon</h2>
        <div class="grid gap-4 sm:grid-cols-2">
            <label class="flex flex-col"><span class="mb-1 font-semibold">Navn/Firmanavn</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                                      id="buyer-name"
                                                                                                      required></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Organisasjonsnr (valgfritt)</span><input
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="buyer-org"></label>
            <label class="sm:col-span-2 flex flex-col"><span class="mb-1 font-semibold">Adresse</span><textarea
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="buyer-address" required
                    rows="2"></textarea></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Postnummer/Sted</span><input
                    class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" id="buyer-postcode"
                    required></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">E-post</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                              id="buyer-email"
                                                                                              type="email"></label>
        </div>
    </section>

    <!-- ========== FAKTURADETALJER ========= -->
    <section class="mb-10">
        <h2 class="mb-4 text-xl font-semibold">Fakturadetaljer</h2>
        <div class="grid gap-4 sm:grid-cols-3">
            <label class="flex flex-col"><span class="mb-1 font-semibold">Fakturanr</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                                 id="inv-number"
                                                                                                 required></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Fakturadato</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                                   id="inv-date" required
                                                                                                   type="date"></label>
            <label class="flex flex-col"><span class="mb-1 font-semibold">Forfallsdato</span><input class="rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400"
                                                                                                    id="due-date" required
                                                                                                    type="date"></label>
        </div>
    </section>

    <!-- ========== VARELINJER ========= -->
    <section class="mb-10">
        <h2 class="mb-4 text-xl font-semibold">Varer / Tjenester</h2>
        <table class="mb-6 w-full border-collapse text-sm" id="items-table">
            <thead>
            <tr class="border-b font-semibold">
                <th class="py-2 text-left">Beskrivelse</th>
                <th class="py-2 text-left">Antall</th>
                <th class="py-2 text-left">Pris (NOK)</th>
                <th class="py-2 text-left">MVA %</th>
                <th class="py-2 text-left">Sum</th>
                <th class="py-2"></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="inline-flex items-center rounded-xl bg-gray-200 px-6 py-2.5 text-gray-700 hover:bg-gray-300"
                id="add-row">Legg
            til rad
        </button>
    </section>

    <!-- ========== TOTALER + PDF ========= -->
    <section class="mb-10 flex flex-col items-end">
        <div class="mb-4 w-full max-w-xs space-y-1 text-right">
            <div>
                <span class="font-semibold">Delsum:</span> <span class="inline-block w-28 text-right"
                                                                 id="tot-sub">0.00</span> NOK
            </div>
            <div>
                <span class="font-semibold">MVA:</span> <span class="inline-block w-28 text-right"
                                                              id="tot-vat">0.00</span> NOK
            </div>
            <div class="border-t pt-1 text-lg font-semibold">Sum å betale: <span class="inline-block w-28 text-right"
                                                                                 id="tot-grand">0.00</span>
                NOK
            </div>
        </div>
        <button class="inline-flex items-center rounded-xl bg-blue-500 px-6 py-2.5 text-white shadow transition hover:-translate-y-0.5 hover:shadow-lg"
                id="download-pdf">
            Last ned som PDF
        </button>
    </section>
</main>

<script>
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => [...ctx.querySelectorAll(sel)];
    const money = n => (Number(n) || 0).toFixed(2);

    const FIELD_IDS = [
        'seller-name', 'seller-account', 'seller-address', 'seller-postcode',
        'seller-phone', 'seller-email', 'buyer-name', 'buyer-org',
        'buyer-address', 'buyer-postcode', 'buyer-email', 'inv-number',
        'inv-date', 'due-date'
    ];

    const calcRow = tr => {
        const qty = tr.querySelector('.qty').value;
        const price = tr.querySelector('.price').value;
        const vat = tr.querySelector('.vat').value;
        // This calculation was slightly off. The sum should not include VAT.
        const sub = qty * price;
        tr.querySelector('.sub').value = money(sub); // Row subtotal is without VAT
    };

    const calcTotals = () => {
        let net = 0, vatTotal = 0;
        $$('#items-table tbody tr').forEach(tr => {
            calcRow(tr); // This now only calculates row subtotal (net)
            const qty = Number(tr.querySelector('.qty').value) || 0;
            const price = Number(tr.querySelector('.price').value) || 0;
            const vatRate = Number(tr.querySelector('.vat').value) || 0;
            const base = qty * price;
            net += base;
            vatTotal += base * (vatRate / 100);
        });
        $('#tot-sub').textContent = money(net);
        $('#tot-vat').textContent = money(vatTotal);
        $('#tot-grand').textContent = money(net + vatTotal);
    };

    const saveState = () => {
        const state = Object.fromEntries(
            FIELD_IDS.map(id => [id, $('#' + id).value])
        );
        state.items = $('#items-table tbody').innerHTML;
        localStorage.setItem('invoice', JSON.stringify(state));
    };

    const loadState = () => {
        const raw = localStorage.getItem('invoice');
        if (!raw) return;
        try {
            const state = JSON.parse(raw);
            FIELD_IDS.forEach(id => {
                if (state[id]) $('#' + id).value = state[id]
            });
            if (state.items) $('#items-table tbody').innerHTML = state.items;
            calcTotals();
        } catch (e) {
            console.error("Could not load state from localStorage", e);
            localStorage.removeItem('invoice');
        }
    };

    const addItemRow = () => {
        $('#items-table tbody').insertAdjacentHTML('beforeend', `
    <tr>
      <td><input class="item w-full rounded-lg border border-gray-300 px-3 py-2 focus:ring-2 focus:ring-blue-400" required></td>
      <td><input type="number" value="1" min="0" class="qty w-full rounded-lg border border-gray-300 px-3 py-2 text-right focus:ring-2 focus:ring-blue-400"></td>
      <td><input type="number" min="0" step="0.01" class="price w-full rounded-lg border border-gray-300 px-3 py-2 text-right focus:ring-2 focus:ring-blue-400" placeholder="0.00"></td>
      <td><input type="number" value="25" min="0" class="vat w-full rounded-lg border border-gray-300 px-3 py-2 text-right focus:ring-2 focus:ring-blue-400"></td>
      <td><input disabled class="sub w-full rounded-lg border-gray-200 bg-gray-50 px-3 py-2 text-right" placeholder="0.00"></td>
      <td><button class="del inline-flex items-center rounded-xl bg-gray-200 px-4 py-1.5 text-gray-700 hover:bg-gray-300">Fjern</button></td>
    </tr>`);
        calcTotals();
        saveState();
    };

    // --- COMPLETELY REWRITTEN PDF GENERATION FUNCTION ---
    // This function manually builds the PDF for maximum reliability.
    const downloadPDF = () => {
        const {jsPDF} = window.jspdf;
        const doc = new jsPDF({orientation: 'p', unit: 'mm', format: 'a4'});

        const pdfButton = $('#download-pdf');
        pdfButton.disabled = true;
        pdfButton.textContent = 'Genererer...';

        try {
            const margin = 15;
            const docWidth = doc.internal.pageSize.getWidth();
            let y = 20;

            // --- Document Header ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(20);
            doc.text('Faktura', docWidth / 2, y, {align: 'center'});
            y += 15;

            // --- Seller and Buyer Info (2 columns) ---
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            const col1 = margin;
            const col2 = docWidth / 2;
            let y1 = y; // Y-cursor for column 1
            let y2 = y; // Y-cursor for column 2

            // Seller
            doc.setFont('helvetica', 'bold');
            doc.text('Fra (Selger):', col1, y1);
            y1 += 6;
            doc.setFont('helvetica', 'normal');
            doc.text($('#seller-name').value, col1, y1);
            y1 += 5;
            $('#seller-address').value.split('\n').forEach(line => {
                doc.text(line, col1, y1);
                y1 += 5;
            });
            doc.text($('#seller-postcode').value, col1, y1);
            y1 += 5;
            if ($('#seller-phone').value) {
                doc.text(`Tlf: ${$('#seller-phone').value}`, col1, y1);
                y1 += 5;
            }
            if ($('#seller-email').value) {
                doc.text(`E-post: ${$('#seller-email').value}`, col1, y1);
                y1 += 5;
            }

            // Buyer
            doc.setFont('helvetica', 'bold');
            doc.text('Til (Kjøper):', col2, y2);
            y2 += 6;
            doc.setFont('helvetica', 'normal');
            doc.text($('#buyer-name').value, col2, y2);
            y2 += 5;
            if ($('#buyer-org').value) {
                doc.text(`Org.nr: ${$('#buyer-org').value}`, col2, y2);
                y2 += 5;
            }
            $('#buyer-address').value.split('\n').forEach(line => {
                doc.text(line, col2, y2);
                y2 += 5;
            });
            doc.text($('#buyer-postcode').value, col2, y2);
            y2 += 5;

            y = Math.max(y1, y2) + 10;

            // --- Invoice Details ---
            doc.setFont('helvetica', 'bold');
            doc.text(`Fakturanummer:`, margin, y);
            doc.text(`Fakturadato:`, docWidth / 3, y);
            doc.text(`Forfallsdato:`, docWidth / 3 * 2, y);
            y += 5;
            doc.setFont('helvetica', 'normal');
            doc.text(`${$('#inv-number').value}`, margin, y);
            doc.text(`${$('#inv-date').value}`, docWidth / 3, y);
            doc.text(`${$('#due-date').value}`, docWidth / 3 * 2, y);
            y += 15;

            // --- Items Table ---
            const tableHeaders = ['Beskrivelse', 'Antall', 'À-pris', 'MVA %', 'Sum (NOK)'];
            const colWidths = [85, 20, 25, 20, 25];
            let x = margin;

            // Header
            doc.setFont('helvetica', 'bold');
            doc.setFillColor(230, 230, 230); // Light gray
            doc.rect(margin, y - 5, docWidth - margin * 2, 8, 'F');
            tableHeaders.forEach((header, i) => {
                const align = i > 0 ? 'right' : 'left';
                doc.text(header, i === 0 ? x : x + colWidths[i] - 2, y, {align});
                x += colWidths[i];
            });
            y += 8;

            // Rows
            doc.setFont('helvetica', 'normal');
            $$('#items-table tbody tr').forEach(tr => {
                x = margin;
                const item = tr.querySelector('.item').value;
                const qty = tr.querySelector('.qty').value;
                const price = money(tr.querySelector('.price').value);
                const vat = tr.querySelector('.vat').value;
                const sub = money(tr.querySelector('.sub').value);

                doc.text(item, x, y);
                doc.text(qty, x + colWidths[0] + colWidths[1] - 2, y, {align: 'right'});
                doc.text(price, x + colWidths[0] + colWidths[1] + colWidths[2] - 2, y, {align: 'right'});
                doc.text(vat, x + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] - 2, y, {align: 'right'});
                doc.text(sub, docWidth - margin - 2, y, {align: 'right'});
                y += 7; // Add space for next row
                if (y > 270) { // Page break check
                    doc.addPage();
                    y = margin;
                }
            });

            // --- Totals Section ---
            y += 5;
            const totalX = docWidth - margin - 50;
            const totalValX = docWidth - margin;
            doc.line(totalX - 5, y, totalValX, y); // Separator line
            y += 5;

            doc.setFont('helvetica', 'normal');
            doc.text('Delsum:', totalX, y, {align: 'right'});
            doc.text(`${$('#tot-sub').textContent} NOK`, totalValX, y, {align: 'right'});
            y += 6;
            doc.text(`MVA:`, totalX, y, {align: 'right'});
            doc.text(`${$('#tot-vat').textContent} NOK`, totalValX, y, {align: 'right'});
            y += 6;
            doc.setFont('helvetica', 'bold');
            doc.text('Sum å betale:', totalX, y, {align: 'right'});
            doc.text(`${$('#tot-grand').textContent} NOK`, totalValX, y, {align: 'right'});
            y += 10;

            // --- Payment Info ---
            doc.setFontSize(12);
            doc.text(`Betales til konto: ${$('#seller-account').value}`, margin, y);
            y += 20;
            doc.text(`Generert gratis på reai.no, ReAI er et gratis regnskapsprogram for bedrifter`, margin, y);
            y += 6;
            doc.text(`Gratis fakturaer lages her: reai.no/pages/lag-faktura`, margin, y);


            // --- Save the file ---
            const filename = `Faktura_${$('#inv-number').value || 'ny'}.pdf`;
            doc.save(filename);

        } catch (error) {
            console.error("Failed to generate PDF:", error);
            alert("En feil oppstod under PDF-genereringen. Sjekk konsollen for detaljer.");
        } finally {
            pdfButton.disabled = false;
            pdfButton.textContent = 'Last ned som PDF';
        }
    };

    document.addEventListener('input', e => {
        const isRowInput = ['qty', 'price', 'vat', 'item'].some(c => e.target.classList.contains(c));
        if (isRowInput) calcTotals();
        if (isRowInput || FIELD_IDS.includes(e.target.id)) {
            // Debounce saveState to avoid excessive localStorage writes
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(saveState, 300);
        }
    });

    document.addEventListener('click', e => {
        if (e.target.id === 'add-row') addItemRow();
        if (e.target.id === 'download-pdf') downloadPDF();
        if (e.target.classList.contains('del')) {
            e.target.closest('tr').remove();
            calcTotals();
            saveState();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        if ($$('#items-table tbody tr').length === 0) {
            addItemRow();
        }
        // Set default dates if empty
        if (!$('#inv-date').value) {
            $('#inv-date').valueAsDate = new Date();
        }
        if (!$('#due-date').value) {
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 14); // 14 days due date
            $('#due-date').valueAsDate = dueDate;
        }
    });
</script>


{{ end }}
